<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L1 Cache v2.1 - CS Study System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Configuração Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' },
                        primary: { 500: '#3b82f6', 600: '#2563eb' },
                    },
                    animation: {
                        'flip': 'flip 0.6s forwards',
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'toast-slide': 'toastSlide 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        toastSlide: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', system-ui, sans-serif; overflow-x: hidden; }

        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose strong { color: #60a5fa; font-weight: 700; }
        .prose em { color: #facc15; font-style: italic; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; text-align: left; display: inline-block; }
        
        .prose code { 
            background: #1e293b; color: #a5b4fc; padding: 0.2em 0.4em; border-radius: 0.3em; 
            font-family: 'Fira Code', monospace; font-size: 0.9em; border: 1px solid #334155;
        }
        .prose pre { 
            background: #0f172a; padding: 1em; border-radius: 0.5em; overflow-x: auto; 
            margin: 1em 0; border: 1px solid #1e293b; text-align: left;
        }
        
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .glass { backdrop-filter: blur(8px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, deleteDoc, updateDoc, serverTimestamp, query, increment, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            Cpu, Zap, LogOut, Plus, Trash2, Check, X, Folder, Lock, Trophy, Bold, Italic, Code, List, 
            ArrowLeft, Eye, Filter, Save, RotateCcw, Volume2, Keyboard, Search, LayoutList, PenTool, CheckCircle, AlertCircle
        } from "https://esm.sh/lucide-react@0.344.0?bundle";

        const firebaseConfig = {
            apiKey: "AIzaSyClIIJkYOmAvEKPtXvG-SIi9SzxQpaBN9s",
            authDomain: "ankidigital.firebaseapp.com",
            projectId: "ankidigital",
            storageBucket: "ankidigital.firebasestorage.app",
            messagingSenderId: "407660648093",
            appId: "1:407660648093:web:b7bf69730e90a28cb36674"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- TOAST NOTIFICATION SYSTEM ---
        const Toast = ({ message, type, onClose }) => {
            React.useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bg = type === 'success' ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' : 'bg-red-500/10 border-red-500/20 text-red-400';
            const Icon = type === 'success' ? CheckCircle : AlertCircle;

            return (
                <div className={`fixed top-4 right-4 z-[100] flex items-center gap-3 px-4 py-3 rounded-xl border backdrop-blur-md shadow-2xl animate-toast-slide ${bg}`}>
                    <Icon size={20} />
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        // --- ENGINE ANKI (SM-2) ---
        const calculateNextReview = (rating, currentData) => {
            const interval = currentData?.interval || 0;
            const ease = currentData?.ease || 2.5;
            const state = currentData?.state || 'learning';
            let newInterval = 0, newEase = ease, newState = state;

            if (state === 'learning') {
                if (rating === 1) { newInterval = 5; newState = 'learning'; }
                else if (rating === 2) { newInterval = 10; newState = 'learning'; }
                else if (rating === 3) { newInterval = 15; if (interval >= 15) { newInterval = 1440; newState = 'graduated'; } } 
                else if (rating === 4) { newInterval = 1440; newState = 'graduated'; }
            } else {
                if (rating === 1) { newInterval = 10; newEase = Math.max(1.3, ease - 0.2); newState = 'learning'; }
                else if (rating === 2) { newInterval = Math.floor(interval * 1.2); newEase = Math.max(1.3, ease - 0.15); newState = 'graduated'; }
                else if (rating === 3) { newInterval = Math.floor(interval * ease); newState = 'graduated'; }
                else if (rating === 4) { newInterval = Math.floor(interval * ease * 1.3); newEase = ease + 0.15; newState = 'graduated'; }
            }
            const now = new Date();
            const dueDate = new Date(now.getTime() + newInterval * 60000);
            return { interval: newInterval, ease: newEase, state: newState, dueDate: dueDate };
        };

        const formatTimeButton = (minutes) => {
            if (!minutes && minutes !== 0) return '-';
            if (minutes < 60) return `${minutes}m`;
            if (minutes < 1440) return `${Math.round(minutes/60)}h`;
            return `${Math.round(minutes/1440)}d`;
        };

        const speakText = (htmlText) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = htmlText;
            const text = tempDiv.textContent || tempDiv.innerText || "";
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "pt-BR";
            utterance.rate = 1.2;
            window.speechSynthesis.speak(utterance);
        };

        // --- COMPONENTS ---
        
        const RichTextEditor = ({ value, onChange }) => {
            const execCmd = (cmd) => document.execCommand(cmd, false, null);
            const execBlock = (tag) => document.execCommand('formatBlock', false, tag);

            return (
                <div className="bg-slate-900 border border-slate-700 rounded-lg overflow-hidden flex flex-col h-40 focus-within:border-blue-500 transition-colors">
                    <div className="bg-slate-800 p-1.5 flex gap-1 border-b border-slate-700 flex-wrap">
                        <button type="button" onClick={() => execCmd('bold')} className="p-1.5 hover:bg-slate-700 rounded text-slate-300"><Bold size={14}/></button>
                        <button type="button" onClick={() => execCmd('italic')} className="p-1.5 hover:bg-slate-700 rounded text-slate-300"><Italic size={14}/></button>
                        <button type="button" onClick={() => execCmd('insertUnorderedList')} className="p-1.5 hover:bg-slate-700 rounded text-slate-300"><List size={14}/></button>
                        <button type="button" onClick={() => execBlock('pre')} className="p-1.5 hover:bg-slate-700 rounded text-purple-400"><Code size={14}/></button>
                    </div>
                    <div 
                        className="flex-1 p-3 text-white focus:outline-none overflow-y-auto prose text-sm"
                        contentEditable
                        onInput={(e) => onChange(e.currentTarget.innerHTML)}
                        dangerouslySetInnerHTML={{__html: value || ''}}
                    ></div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [view, setView] = React.useState("loading"); 
            const [cards, setCards] = React.useState([]);
            const [reviews, setReviews] = React.useState({});
            const [studyQueue, setStudyQueue] = React.useState([]);
            const [toast, setToast] = React.useState(null);

            const showToast = (message, type = 'success') => setToast({ message, type });

            React.useEffect(() => {
                const unsub = onAuthStateChanged(auth, async (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        setIsAdmin(currentUser.email?.endsWith("@userpro.com") || false);
                        await loadUserData(currentUser);
                    } else {
                        setIsAdmin(false);
                        setReviews({});
                        await loadPublicCards();
                    }
                    setView(currentUser ? "decks" : "auth");
                });
                return () => unsub();
            }, []);

            const loadPublicCards = async () => {
                try {
                    const q = query(collection(db, "cards"));
                    const snapshot = await getDocs(q);
                    setCards(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                } catch (error) { console.error(error); }
            };

            const loadUserData = async (currentUser) => {
                await loadPublicCards();
                try {
                    const q = query(collection(db, `users/${currentUser.uid}/reviews`));
                    const snapshot = await getDocs(q);
                    const userReviews = {};
                    snapshot.forEach(doc => { userReviews[doc.id] = doc.data(); });
                    setReviews(userReviews);
                    
                    // Init stats if empty
                    const statsRef = doc(db, 'leaderboard', currentUser.uid);
                    const statsSnap = await getDoc(statsRef);
                    if (!statsSnap.exists()) {
                        await setDoc(statsRef, { email: currentUser.email, total: 0, retention: 0, timeStudied: 0 });
                    }
                } catch (error) { console.error(error); }
            };

            const startStudy = (category, subcategory = null, forceCram = false) => {
                const now = new Date();
                let queue = cards.filter(c => {
                    if (category && c.category !== category) return false;
                    if (subcategory && c.subcategory !== subcategory) return false;
                    return true;
                });

                if (user && !forceCram) {
                    queue = queue.filter(card => {
                        const review = reviews[card.id];
                        if (!review) return true; 
                        const dueDate = review.dueDate?.toDate ? review.dueDate.toDate() : new Date(review.dueDate || now);
                        return dueDate <= now;
                    });
                } else if (!user) queue = queue.sort(() => Math.random() - 0.5);
                
                if (forceCram) queue = queue.sort(() => Math.random() - 0.5);

                if (queue.length === 0) {
                    if (!forceCram && confirm("Você está em dia! Modo revisão extra?")) startStudy(category, subcategory, true);
                    else showToast("Nenhum card disponível.", "error");
                    return;
                }
                setStudyQueue(queue);
                setView("study");
            };

            return (
                <div className="min-h-screen flex flex-col bg-slate-950 text-slate-200 font-sans selection:bg-purple-500/30">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {view === "loading" ? (
                        <div className="min-h-screen flex flex-col items-center justify-center bg-slate-950 text-blue-500">
                            <div className="w-12 h-12 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                            <span className="font-mono text-xs tracking-[0.2em] text-blue-400">LOADING V2.1</span>
                        </div>
                    ) : view === "auth" ? (
                        <AuthScreen onLogin={() => setView("decks")} guestMode={() => setView("decks")} showToast={showToast} />
                    ) : (
                        <>
                            <nav className="border-b border-slate-800 bg-slate-950/80 sticky top-0 z-50 backdrop-blur-md">
                                <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
                                    <div className="flex items-center gap-2 font-bold text-lg cursor-pointer" onClick={() => setView("decks")}>
                                        <div className="bg-gradient-to-br from-blue-600 to-purple-600 p-1.5 rounded-lg">
                                            <Cpu size={18} className="text-white" />
                                        </div>
                                        <span className="hidden sm:inline text-white">L1 <span className="text-blue-500">Cache</span></span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {user && <button onClick={() => setView("leaderboard")} className="p-2 text-yellow-500 bg-yellow-500/10 rounded-full hover:bg-yellow-500/20"><Trophy size={18} /></button>}
                                        {isAdmin && <button onClick={() => setView("admin")} className="p-2 text-amber-500 bg-amber-500/10 rounded-full hover:bg-amber-500/20"><Lock size={18} /></button>}
                                        {user && <button onClick={() => signOut(auth)} className="p-2 text-slate-400 hover:text-red-400"><LogOut size={18}/></button>}
                                    </div>
                                </div>
                            </nav>

                            <main className="flex-1 max-w-6xl mx-auto w-full p-4 pb-20 md:pb-4">
                                {view === "decks" && <DecksView cards={cards} startStudy={startStudy} reviews={reviews} />}
                                {view === "study" && <StudySession queue={studyQueue} user={user} reviews={reviews} setReviews={setReviews} onFinish={() => setView("decks")} showToast={showToast} />}
                                {view === "leaderboard" && <LeaderboardView />}
                                {view === "admin" && <AdminPanel cards={cards} setCards={setCards} onExit={() => setView("decks")} showToast={showToast} />}
                            </main>
                        </>
                    )}
                </div>
            );
        };

        const AuthScreen = ({ onLogin, guestMode, showToast }) => {
            const [isRegister, setIsRegister] = React.useState(false);
            const [email, setEmail] = React.useState("");
            const [password, setPassword] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                    onLogin();
                } catch (err) { showToast("Erro: " + err.message, "error"); } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-950 relative overflow-hidden">
                    <div className="w-full max-w-md glass p-8 rounded-2xl shadow-2xl relative z-10">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-white mb-2">L1 Cache <span className="text-blue-400">2.1</span></h1>
                            <p className="text-slate-400 text-sm">Otimização de memória para CS.</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="email" placeholder="Email" className="w-full bg-slate-900/50 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition-colors" value={email} onChange={e => setEmail(e.target.value)} />
                            <input type="password" placeholder="Senha" className="w-full bg-slate-900/50 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition-colors" value={password} onChange={e => setPassword(e.target.value)} />
                            <button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold p-3 rounded-xl transition-all shadow-lg shadow-blue-900/20 disabled:opacity-50">
                                {loading ? "Processando..." : (isRegister ? "Registrar" : "Entrar")}
                            </button>
                        </form>
                        <div className="mt-6 flex justify-between text-sm text-slate-500 pt-4 border-t border-slate-700/50">
                            <button onClick={() => setIsRegister(!isRegister)} className="hover:text-blue-400">{isRegister ? "Tenho conta" : "Criar conta"}</button>
                            <button onClick={guestMode} className="hover:text-white">Visitante</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DecksView = ({ cards, startStudy, reviews }) => {
            const structure = {};
            cards.forEach(card => {
                const cat = card.category || "Geral";
                const sub = card.subcategory || "Diversos";
                if (!structure[cat]) structure[cat] = {};
                if (!structure[cat][sub]) structure[cat][sub] = [];
                structure[cat][sub].push(card);
            });

            // Calculate Heatmap Data
            const days = Array.from({length: 28}, (_, i) => {
                const d = new Date(); d.setDate(d.getDate() - (27 - i));
                return d.toISOString().split('T')[0];
            });
            const activityMap = {};
            Object.values(reviews).forEach(r => {
                if(r.lastReviewed) {
                   const dateKey = r.lastReviewed.toDate().toISOString().split('T')[0];
                   activityMap[dateKey] = (activityMap[dateKey] || 0) + 1;
                }
            });

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="glass p-4 rounded-xl">
                        <div className="flex items-center gap-2 mb-3 text-slate-400 text-xs uppercase font-bold tracking-wider">
                            <div className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div> Consistency Streak
                        </div>
                        <div className="flex justify-between gap-1 h-10 items-end">
                            {days.map(day => {
                                const count = activityMap[day] || 0;
                                let h = "h-1 bg-slate-800";
                                if (count > 0) h = "h-3 bg-blue-900";
                                if (count > 5) h = "h-5 bg-blue-600";
                                if (count > 15) h = "h-8 bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]";
                                return <div key={day} className={`w-full rounded-sm transition-all duration-500 ${h}`}></div>;
                            })}
                        </div>
                    </div>

                    <div className="grid gap-4">
                        {Object.keys(structure).sort().map(cat => (
                            <div key={cat} className="glass rounded-xl overflow-hidden group">
                                <div className="p-3 border-b border-slate-700/50 flex justify-between items-center bg-slate-900/40">
                                    <h3 className="font-bold text-white flex items-center gap-2">
                                        <Folder size={16} className="text-amber-500"/> {cat}
                                    </h3>
                                    <button onClick={() => startStudy(cat)} className="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-lg font-bold transition-all flex items-center gap-1">
                                        <Zap size={12} /> Estudar
                                    </button>
                                </div>
                                <div className="p-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {Object.keys(structure[cat]).map(sub => (
                                        <div key={sub} onClick={() => startStudy(cat, sub)} className="flex justify-between items-center p-2.5 hover:bg-slate-800/50 rounded-lg cursor-pointer transition-colors border border-transparent hover:border-slate-700/50">
                                            <span className="text-slate-300 text-sm flex items-center gap-2">
                                                <div className="w-1 h-1 bg-slate-500 rounded-full"></div> {sub}
                                            </span>
                                            <span className="text-[10px] bg-slate-800 text-slate-400 px-1.5 py-0.5 rounded border border-slate-700 font-mono">{structure[cat][sub].length}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const StudySession = ({ queue, user, reviews, setReviews, onFinish, showToast }) => {
            const [index, setIndex] = React.useState(0);
            const [isFlipped, setIsFlipped] = React.useState(false);
            const [finished, setFinished] = React.useState(false);
            const [startTime, setStartTime] = React.useState(Date.now());
            
            const card = queue[index];

            const handleRate = async (rating) => {
                if (user) {
                    const timeSpent = Date.now() - startTime;
                    setStartTime(Date.now());
                    const current = reviews[card.id] || {};
                    const result = calculateNextReview(rating, current);
                    
                    const newReviews = { ...reviews, [card.id]: { ...result, dueDate: { toDate: () => result.dueDate } } };
                    setReviews(newReviews);
                    
                    try {
                        await setDoc(doc(db, `users/${user.uid}/reviews/${card.id}`), { ...result, lastReviewed: serverTimestamp() });
                        
                        const statsRef = doc(db, 'leaderboard', user.uid);
                        // Safe update for stats
                        await updateDoc(statsRef, { 
                            total: Object.keys(newReviews).length,
                            retention: (Object.values(newReviews).filter(r => r.state === 'graduated').length / Object.keys(newReviews).length) * 100,
                            timeStudied: increment(timeSpent)
                        });
                    } catch(e) {}
                }
                
                setIsFlipped(false);
                if (index < queue.length - 1) setIndex(index + 1);
                else setFinished(true);
            };

            if (finished) return (
                <div className="flex flex-col items-center justify-center h-[60vh] text-center animate-fade-in">
                    <div className="w-20 h-20 bg-emerald-500/10 rounded-full flex items-center justify-center text-emerald-500 mb-6 border border-emerald-500/20 shadow-[0_0_30px_rgba(16,185,129,0.2)]"><Check size={40} /></div>
                    <h2 className="text-2xl font-bold text-white mb-2">Sessão Concluída</h2>
                    <button onClick={onFinish} className="bg-slate-800 hover:bg-slate-700 text-white px-6 py-2 rounded-xl border border-slate-700 transition-all">Voltar</button>
                </div>
            );

            return (
                <div className="max-w-3xl mx-auto h-[calc(100vh-140px)] flex flex-col perspective-1000 mt-2">
                    {/* Progress Bar */}
                    <div className="w-full bg-slate-900 h-1.5 rounded-full mb-4 overflow-hidden">
                        <div className="bg-blue-600 h-full transition-all duration-300" style={{width: `${((index + 1) / queue.length) * 100}%`}}></div>
                    </div>

                    <div className="relative flex-1 group">
                        <div className={`w-full h-full duration-500 transform-style-3d transition-transform relative ${isFlipped ? 'rotate-y-180' : ''}`}>
                            {/* FRONT */}
                            <div className="absolute inset-0 backface-hidden glass border border-slate-700 rounded-3xl p-6 flex flex-col items-center justify-center text-center shadow-2xl bg-slate-900/90">
                                <div className="text-xs text-blue-400 font-mono mb-4 uppercase tracking-wider">{card.category}</div>
                                <div className="prose text-xl md:text-2xl font-medium text-white flex-1 flex flex-col items-center justify-center w-full overflow-y-auto custom-scrollbar" dangerouslySetInnerHTML={{__html: card.front}}></div>
                                <div className="flex gap-4 mt-6">
                                    <button onClick={(e) => { e.stopPropagation(); speakText(card.front); }} className="p-3 rounded-full bg-slate-800 text-slate-400 hover:text-white"><Volume2 size={20}/></button>
                                    <button onClick={() => setIsFlipped(true)} className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-blue-900/30">Mostrar Resposta</button>
                                </div>
                            </div>
                            {/* BACK */}
                            <div className="absolute inset-0 backface-hidden rotate-y-180 glass border-2 border-blue-500/30 rounded-3xl p-6 flex flex-col items-center justify-center text-center shadow-2xl bg-slate-900/95">
                                <div className="prose text-lg text-slate-200 w-full h-full overflow-y-auto custom-scrollbar flex flex-col items-center justify-center" dangerouslySetInnerHTML={{__html: card.back}}></div>
                            </div>
                        </div>
                    </div>

                    <div className={`grid grid-cols-4 gap-2 md:gap-4 mt-6 transition-all duration-300 ${isFlipped ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                        {[
                            {l: 'Errei', c: 'text-red-400 border-red-900/30 bg-red-900/10', v: 1},
                            {l: 'Difícil', c: 'text-slate-300 border-slate-700 bg-slate-800/50', v: 2},
                            {l: 'Bom', c: 'text-blue-400 border-blue-900/30 bg-blue-900/10', v: 3},
                            {l: 'Fácil', c: 'text-emerald-400 border-emerald-900/30 bg-emerald-900/10', v: 4}
                        ].map((btn) => (
                            <button key={btn.v} onClick={() => handleRate(btn.v)} className={`p-3 rounded-xl border flex flex-col items-center justify-center transition-transform active:scale-95 ${btn.c}`}>
                                <span className="font-bold text-sm">{btn.l}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ cards, setCards, onExit, showToast }) => {
            const [form, setForm] = React.useState({ front: '', back: '', category: 'Geral', subcategory: '' });
            const [editingId, setEditingId] = React.useState(null);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [mobileTab, setMobileTab] = React.useState('list'); // 'list' or 'form'

            const filteredCards = cards.filter(c => {
                const searchLower = searchTerm.toLowerCase();
                return (c.front?.toLowerCase().includes(searchLower) || c.back?.toLowerCase().includes(searchLower) || c.category?.toLowerCase().includes(searchLower));
            });

            const handleSave = async (e) => {
                e.preventDefault();
                if(!form.front || !form.back) return showToast("Preencha frente e verso!", "error");
                try {
                    if (editingId) {
                        await updateDoc(doc(db, "cards", editingId), form);
                        setCards(cards.map(c => c.id === editingId ? { ...c, ...form } : c));
                        setEditingId(null);
                        showToast("Card atualizado!");
                    } else {
                        const ref = await addDoc(collection(db, "cards"), { ...form, createdAt: serverTimestamp() });
                        setCards([...cards, { id: ref.id, ...form }]);
                        showToast("Card criado!");
                    }
                    setForm({ ...form, front: '', back: '' });
                    setMobileTab('list'); // Go back to list on mobile after save
                } catch (e) { showToast("Erro: " + e.message, "error"); }
            };

            const handleEdit = (card) => {
                setForm(card);
                setEditingId(card.id);
                setMobileTab('form'); // Switch to form tab on mobile
            };

            const handleDelete = async (id) => {
                if(confirm("Deletar permanentemente?")) {
                    await deleteDoc(doc(db, "cards", id));
                    setCards(cards.filter(c => c.id !== id));
                    showToast("Card deletado.");
                }
            };

            return (
                <div className="glass flex flex-col h-[calc(100vh-85px)] md:h-[calc(100vh-100px)] rounded-xl border border-slate-700 overflow-hidden shadow-2xl">
                    {/* Header */}
                    <div className="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-900/50">
                        <div className="flex items-center gap-2 text-amber-500 font-bold">
                            <Lock size={18}/> <span className="hidden md:inline">Admin Console</span>
                        </div>
                        
                        {/* Mobile Tabs Switcher */}
                        <div className="flex md:hidden bg-slate-800 rounded-lg p-1 gap-1">
                            <button onClick={() => setMobileTab('list')} className={`p-1.5 rounded-md transition-all ${mobileTab === 'list' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}><LayoutList size={18}/></button>
                            <button onClick={() => setMobileTab('form')} className={`p-1.5 rounded-md transition-all ${mobileTab === 'form' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}><PenTool size={18}/></button>
                        </div>

                        <button onClick={onExit} className="bg-slate-800 p-2 rounded-lg hover:bg-slate-700 text-slate-300"><X size={18} /></button>
                    </div>

                    <div className="flex flex-1 overflow-hidden relative">
                        {/* Left Column: List (Hidden on Mobile if Tab != list) */}
                        <div className={`w-full md:w-1/3 flex-col border-r border-slate-700/50 bg-slate-900/30 ${mobileTab === 'list' ? 'flex' : 'hidden md:flex'}`}>
                            <div className="p-3 border-b border-slate-700/50">
                                <div className="relative">
                                    <Search size={16} className="absolute left-3 top-3 text-slate-500"/>
                                    <input 
                                        type="text" 
                                        placeholder="Buscar por conteúdo..." 
                                        className="w-full bg-slate-800 pl-9 pr-3 py-2.5 rounded-lg text-sm text-white border border-slate-700 focus:border-blue-500 outline-none"
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                {filteredCards.map(c => (
                                    <div key={c.id} onClick={() => handleEdit(c)} className={`p-3 rounded-lg border cursor-pointer transition-all ${editingId === c.id ? 'bg-blue-900/20 border-blue-500/50' : 'bg-slate-800/40 border-slate-800 hover:border-slate-600'}`}>
                                        <div className="flex justify-between mb-1">
                                            <span className="text-[10px] text-blue-400 font-mono bg-blue-900/20 px-1.5 rounded">{c.category}</span>
                                            {editingId === c.id && <span className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>}
                                        </div>
                                        <div className="text-slate-300 text-xs line-clamp-2" dangerouslySetInnerHTML={{__html: c.front.replace(/<[^>]*>?/gm, '')}}></div>
                                        <div className="flex justify-end mt-2">
                                            <button onClick={(e) => { e.stopPropagation(); handleDelete(c.id); }} className="text-slate-500 hover:text-red-400"><Trash2 size={14}/></button>
                                        </div>
                                    </div>
                                ))}
                                {filteredCards.length === 0 && <div className="text-center text-slate-500 py-8 text-sm">Nada encontrado.</div>}
                            </div>
                        </div>

                        {/* Right Column: Form (Hidden on Mobile if Tab != form) */}
                        <div className={`flex-1 flex-col bg-slate-900/20 ${mobileTab === 'form' ? 'flex' : 'hidden md:flex'}`}>
                            <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                <form id="cardForm" onSubmit={handleSave} className="space-y-4 max-w-2xl mx-auto">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1">Deck</label>
                                            <input className="w-full bg-slate-800 p-2.5 rounded-lg text-white text-sm border border-slate-700 focus:border-blue-500 outline-none" placeholder="Ex: Algoritmos" value={form.category} onChange={e => setForm({...form, category: e.target.value})} list="cats" />
                                            <datalist id="cats">{[...new Set(cards.map(c => c.category))].map(c => <option key={c} value={c} />)}</datalist>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1">Tópico</label>
                                            <input className="w-full bg-slate-800 p-2.5 rounded-lg text-white text-sm border border-slate-700 focus:border-blue-500 outline-none" placeholder="Ex: Arrays" value={form.subcategory} onChange={e => setForm({...form, subcategory: e.target.value})} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Frente (Pergunta)</label>
                                        <RichTextEditor value={form.front} onChange={(val) => setForm({...form, front: val})} />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Verso (Resposta)</label>
                                        <RichTextEditor value={form.back} onChange={(val) => setForm({...form, back: val})} />
                                    </div>
                                </form>
                            </div>
                            <div className="p-4 border-t border-slate-700 bg-slate-900/80 flex gap-3">
                                {editingId && (
                                    <button type="button" onClick={() => { setEditingId(null); setForm({ front: '', back: '', category: 'Geral', subcategory: '' }); setMobileTab('list'); }} className="px-4 bg-slate-700 rounded-lg text-white font-bold hover:bg-slate-600 transition-colors"><RotateCcw size={18}/></button>
                                )}
                                <button form="cardForm" className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-900/20 transition-all flex justify-center items-center gap-2">
                                    <Save size={18} /> {editingId ? 'Salvar Edição' : 'Criar Card'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LeaderboardView = () => {
            return (
                <div className="text-center p-12 text-slate-500 animate-fade-in">
                    <Trophy size={48} className="mx-auto mb-4 opacity-20" />
                    <h2 className="text-xl font-bold text-slate-400">Ranking em Manutenção</h2>
                    <p className="text-sm">Otimizando banco de dados para v2.1...</p>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
