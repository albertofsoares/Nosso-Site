<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L1 Cache v2.6 - CS Study System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' }, primary: { 500: '#3b82f6', 600: '#2563eb' } },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-in-out', 'slide-up': 'slideUp 0.4s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } },
                    typography: (theme) => ({ DEFAULT: { css: { color: theme('colors.slate.300'), strong: { color: theme('colors.white') } } } })
                }
            }
        }
    </script>
    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', system-ui, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose strong { color: #60a5fa; font-weight: 700; }
        .prose em { color: #facc15; font-style: italic; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin: 0.5em 0; }
        .prose code { background: #1e293b; color: #a5b4fc; padding: 0.2em 0.4em; border-radius: 0.3em; font-family: 'Fira Code', monospace; font-size: 0.9em; border: 1px solid #334155; }
        .prose pre { background: #0f172a; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin: 1em 0; border: 1px solid #1e293b; text-align: left; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, deleteDoc, updateDoc, serverTimestamp, query, where, increment, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { Cpu, Zap, LogOut, Plus, Trash2, Pencil, Check, X, Folder, Lock, Trophy, Bold, Italic, Code, List, Eye, Filter, Save, RotateCcw, Volume2, Keyboard, Calendar, Settings, PlayCircle, Undo2, Search, ChevronDown, ChevronRight, BookOpen } from "https://esm.sh/lucide-react@0.344.0?bundle";

        const firebaseConfig = {
            apiKey: "AIzaSyClIIJkYOmAvEKPtXvG-SIi9SzxQpaBN9s",
            authDomain: "ankidigital.firebaseapp.com",
            projectId: "ankidigital",
            storageBucket: "ankidigital.firebasestorage.app",
            messagingSenderId: "407660648093",
            appId: "1:407660648093:web:b7bf69730e90a28cb36674"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UTILS ---
        // Normalização robusta para corrigir o bug dos filtros
        const normalize = (val) => String(val || '').trim();

        const calculateNextReview = (rating, currentData) => {
            const interval = currentData?.interval || 0;
            const ease = currentData?.ease || 2.5;
            const state = currentData?.state || 'learning';
            let newInterval = 0, newEase = ease, newState = state;

            if (state === 'learning') {
                if (rating === 1) { newInterval = 5; newState = 'learning'; }
                else if (rating === 2) { newInterval = 10; newState = 'learning'; }
                else if (rating === 3) { newInterval = 15; if (interval >= 15) { newInterval = 1440; newState = 'graduated'; } } 
                else if (rating === 4) { newInterval = 1440; newState = 'graduated'; }
            } else {
                if (rating === 1) { newInterval = 10; newEase = Math.max(1.3, ease - 0.2); newState = 'learning'; }
                else if (rating === 2) { newInterval = Math.floor(interval * 1.2); newEase = Math.max(1.3, ease - 0.15); newState = 'graduated'; }
                else if (rating === 3) { newInterval = Math.floor(interval * ease); newState = 'graduated'; }
                else if (rating === 4) { newInterval = Math.floor(interval * ease * 1.3); newEase = ease + 0.15; newState = 'graduated'; }
            }
            return { interval: newInterval, ease: newEase, state: newState, dueDate: new Date(Date.now() + newInterval * 60000) };
        };

        const formatTimeLabel = (min) => !min && min !== 0 ? '-' : min < 60 ? `${min}m` : min < 1440 ? `${Math.round(min/60)}h` : `${Math.round(min/1440)}d`;
        const formatDuration = (ms) => { if (!ms) return "0m"; const h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000); return h > 0 ? `${h}h ${m}m` : `${m}m`; };
        const speakText = (html) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(html.replace(/<[^>]*>/g, ''));
            u.lang = "pt-BR"; u.rate = 1.1; window.speechSynthesis.speak(u);
        };

        // --- COMPONENTS ---
        const Heatmap = ({ reviews }) => {
            const days = Array.from({length: 30}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (29 - i)); return d.toISOString().split('T')[0]; });
            const activity = {};
            Object.values(reviews).forEach(r => { if(r.lastReviewed) activity[r.lastReviewed.toDate().toISOString().split('T')[0]] = (activity[r.lastReviewed.toDate().toISOString().split('T')[0]] || 0) + 1; });
            return (
                <div className="glass p-4 rounded-xl mb-6">
                    <div className="flex items-center gap-2 mb-3 text-slate-400 text-xs uppercase font-bold tracking-wider"><Calendar size={14} /> Consistency Streak (30 Dias)</div>
                    <div className="flex justify-between gap-1">
                        {days.map(d => {
                            const c = activity[d] || 0;
                            return <div key={d} title={`${d}: ${c}`} className={`w-full h-8 rounded-sm transition-all ${c===0?'bg-slate-800':c>20?'bg-emerald-400 shadow-[0_0_10px_rgba(52,211,153,0.5)]':c>10?'bg-blue-500':c>5?'bg-blue-700':'bg-blue-900'} hover:scale-125`}></div>
                        })}
                    </div>
                </div>
            );
        };

        const RichTextEditor = ({ value, onChange }) => {
            const exec = (cmd, val=null) => document.execCommand(cmd, false, val);
            return (
                <div className="bg-slate-900 border border-slate-700 rounded-lg overflow-hidden flex flex-col h-40 focus-within:border-blue-500 transition-colors">
                    <div className="bg-slate-800 p-2 flex gap-1 border-b border-slate-700 flex-wrap">
                        <button type="button" onClick={() => exec('bold')} className="p-1.5 hover:bg-slate-700 rounded text-slate-300"><Bold size={16}/></button>
                        <button type="button" onClick={() => exec('italic')} className="p-1.5 hover:bg-slate-700 rounded text-slate-300"><Italic size={16}/></button>
                        <button type="button" onClick={() => exec('insertUnorderedList')} className="p-1.5 hover:bg-slate-700 rounded text-slate-300"><List size={16}/></button>
                        <button type="button" onClick={() => exec('formatBlock','pre')} className="p-1.5 hover:bg-slate-700 rounded text-purple-400"><Code size={16}/></button>
                    </div>
                    <div className="flex-1 p-4 text-white focus:outline-none overflow-y-auto prose text-sm" contentEditable onInput={(e) => onChange(e.currentTarget.innerHTML)} dangerouslySetInnerHTML={{__html: value || ''}}></div>
                </div>
            );
        };

        const CustomStudyModal = ({ isOpen, onClose, onStart, categories }) => {
            const [mode, setMode] = React.useState('due');
            const [limit, setLimit] = React.useState(20);
            const [selectedCategory, setSelectedCategory] = React.useState('All');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-white"><X size={20}/></button>
                        <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><Settings size={20} className="text-blue-500"/> Estudo Personalizado</h2>
                        <div className="space-y-4">
                            <div><label className="block text-slate-400 text-xs font-bold mb-2">Deck</label>
                                <select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white">
                                    <option value="All">Todas as Matérias</option>{categories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div><label className="block text-slate-400 text-xs font-bold mb-2">Modo</label>
                                <div className="grid grid-cols-2 gap-2">
                                    {[['due','Revisão'], ['cram','Cram'], ['new','Novos'], ['all','Todos']].map(([m, l]) => (
                                        <button key={m} onClick={() => setMode(m)} className={`p-3 rounded-lg text-sm border ${mode === m ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}`}>{l}</button>
                                    ))}
                                </div>
                            </div>
                            <div><label className="block text-slate-400 text-xs font-bold mb-2">Limite</label><input type="number" value={limit} onChange={e => setLimit(Number(e.target.value))} className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white" min="1" max="500" /></div>
                            <button onClick={() => onStart({ category: selectedCategory, mode, limit })} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold p-3 rounded-xl mt-4">Iniciar Sessão</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [view, setView] = React.useState("loading"); 
            const [cards, setCards] = React.useState([]);
            const [reviews, setReviews] = React.useState({});
            const [studyQueue, setStudyQueue] = React.useState([]);
            const [customStudyOpen, setCustomStudyOpen] = React.useState(false);
            
            React.useEffect(() => {
                return onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    if (u) { setIsAdmin(u.email?.endsWith("@userpro.com") || false); await loadUserData(u); } 
                    else { setIsAdmin(false); setReviews({}); await loadPublicCards(); }
                    setView(u ? "decks" : "auth");
                });
            }, []);

            const loadPublicCards = async () => {
                try {
                    const snap = await getDocs(query(collection(db, "cards")));
                    const loaded = snap.docs.map(d => {
                        const dat = d.data();
                        return { id: d.id, ...dat, category: normalize(dat.category || 'Sem Categoria'), lesson: normalize(dat.lesson || 'Geral'), subcategory: normalize(dat.subcategory || 'Geral') };
                    });
                    setCards(loaded);
                } catch (e) { console.error(e); setCards([]); }
            };

            const loadUserData = async (u) => {
                await loadPublicCards();
                try {
                    const snap = await getDocs(query(collection(db, `users/${u.uid}/reviews`)));
                    const rev = {}; snap.forEach(d => rev[d.id] = d.data());
                    setReviews(rev);
                    const statsRef = doc(db, 'leaderboard', u.uid);
                    if (!(await getDoc(statsRef)).exists()) await setDoc(statsRef, { email: u.email, total: 0, retention: 0, timeStudied: 0, lastActive: serverTimestamp() });
                } catch (e) { console.error(e); }
            };

            const getStructure = () => {
                const s = {};
                cards.forEach(c => {
                    if (!s[c.category]) s[c.category] = {};
                    if (!s[c.category][c.lesson]) s[c.category][c.lesson] = {};
                    if (!s[c.category][c.lesson][c.subcategory]) s[c.category][c.lesson][c.subcategory] = [];
                    s[c.category][c.lesson][c.subcategory].push(c);
                });
                return s;
            };

            const startStudy = (category, lesson = null, subcategory = null, customSettings = null) => {
                let queue = cards.filter(c => {
                    if (category && c.category !== category) return false;
                    if (lesson && c.lesson !== lesson) return false;
                    if (subcategory && c.subcategory !== subcategory) return false;
                    return true;
                });

                if (customSettings) {
                    if (customSettings.mode === 'new') queue = queue.filter(c => !reviews[c.id]);
                    else if (customSettings.mode === 'due') queue = queue.filter(c => { const r = reviews[c.id]; return !r || (r.dueDate?.toDate ? r.dueDate.toDate() : new Date(r.dueDate)) <= new Date(); });
                    if (customSettings.mode === 'cram') queue = queue.sort(() => Math.random() - 0.5);
                    else queue = queue.sort(() => Math.random() - 0.5);
                    queue = queue.slice(0, customSettings.limit);
                } else if (user) {
                    queue = queue.filter(c => { const r = reviews[c.id]; return !r || (r.dueDate?.toDate ? r.dueDate.toDate() : new Date(r.dueDate)) <= new Date(); });
                } else {
                    queue = queue.sort(() => Math.random() - 0.5);
                }

                if (queue.length === 0) {
                    if (confirm("Tudo em dia! Deseja revisar aleatoriamente (Cram)?")) setCustomStudyOpen(true);
                    return;
                }
                setStudyQueue(queue); setView("study");
            };

            if (view === "loading") return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-950 text-blue-500"><div className="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"></div><span className="font-mono text-sm tracking-[0.2em] mt-6 text-blue-400">LOADING CORE...</span></div>;
            if (view === "auth") return <AuthScreen onLogin={() => setView("decks")} guestMode={() => setView("decks")} />;

            return (
                <div className="min-h-screen flex flex-col bg-slate-950 text-slate-200 font-sans">
                    <nav className="border-b border-slate-800 bg-slate-950/80 sticky top-0 z-50 backdrop-blur-md">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3 font-bold text-xl cursor-pointer" onClick={() => setView("decks")}>
                                <div className="bg-gradient-to-br from-blue-600 to-purple-600 p-2 rounded-lg"><Cpu size={20} className="text-white" /></div>
                                <span className="text-white tracking-tight">L1 <span className="text-blue-500">Cache</span> <span className="text-[10px] bg-slate-800 px-1 py-0.5 rounded text-slate-400 align-top">v2.6</span></span>
                            </div>
                            <div className="flex items-center gap-4">
                                {user && <button onClick={() => setView("leaderboard")} className="text-yellow-500 flex items-center gap-1 text-sm bg-yellow-500/10 px-3 py-1.5 rounded-full border border-yellow-500/20"><Trophy size={14} /> Rank</button>}
                                {isAdmin && <button onClick={() => setView("admin")} className="text-amber-500 bg-amber-500/10 px-3 py-1.5 rounded-full border border-amber-500/20 flex items-center gap-1 text-sm"><Lock size={14} /> Admin</button>}
                                {user && <button onClick={() => signOut(auth)} className="text-slate-400 hover:text-red-400"><LogOut size={20}/></button>}
                            </div>
                        </div>
                    </nav>
                    <main className="flex-1 max-w-6xl mx-auto w-full p-4">
                        {view === "decks" && <DecksView structure={getStructure()} startStudy={startStudy} totalCards={cards.length} reviews={reviews} onCustom={() => setCustomStudyOpen(true)} />}
                        {view === "study" && <StudySession queue={studyQueue} user={user} reviews={reviews} setReviews={setReviews} onFinish={() => setView("decks")} />}
                        {view === "leaderboard" && <LeaderboardView />}
                        {view === "admin" && isAdmin && <AdminPanel cards={cards} setCards={setCards} onExit={() => setView("decks")} />}
                    </main>
                    <CustomStudyModal isOpen={customStudyOpen} onClose={() => setCustomStudyOpen(false)} onStart={(s) => { setCustomStudyOpen(false); startStudy(s.category === 'All' ? null : s.category, null, null, s); }} categories={[...new Set(cards.map(c => c.category))]} />
                </div>
            );
        };

        const AuthScreen = ({ onLogin, guestMode }) => {
            const [isReg, setIsReg] = React.useState(false);
            const [email, setEmail] = React.useState("");
            const [pass, setPass] = React.useState("");
            const [load, setLoad] = React.useState(false);
            const submit = async (e) => { e.preventDefault(); setLoad(true); try { if (isReg) await createUserWithEmailAndPassword(auth, email, pass); else await signInWithEmailAndPassword(auth, email, pass); onLogin(); } catch (err) { alert(err.message); } finally { setLoad(false); } };
            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-950 relative overflow-hidden">
                    <div className="absolute top-[-20%] left-[-10%] w-[600px] h-[600px] bg-blue-600/20 rounded-full blur-[120px] pointer-events-none"></div>
                    <div className="w-full max-w-md glass p-8 rounded-2xl shadow-2xl relative z-10 animate-slide-up">
                        <div className="text-center mb-8"><h1 className="text-3xl font-bold text-white">L1 Cache <span className="text-blue-400">2.6</span></h1><p className="text-slate-400 text-sm">Acesso ao Mainframe de Estudos</p></div>
                        <form onSubmit={submit} className="space-y-4">
                            <input type="email" placeholder="Email" className="w-full bg-slate-900/50 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500" value={email} onChange={e => setEmail(e.target.value)} />
                            <input type="password" placeholder="Senha" className="w-full bg-slate-900/50 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500" value={pass} onChange={e => setPass(e.target.value)} />
                            <button disabled={load} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold p-3.5 rounded-xl transition-all disabled:opacity-50">{load ? "Processando..." : (isReg ? "Registrar" : "Entrar")}</button>
                        </form>
                        <div className="mt-6 flex justify-between text-sm text-slate-500 pt-4 border-t border-slate-700/50"><button onClick={() => setIsReg(!isReg)} className="hover:text-blue-400">{isReg ? "Já tenho conta" : "Criar conta"}</button><button onClick={guestMode} className="hover:text-white">Visitante</button></div>
                    </div>
                </div>
            );
        };

        const DecksView = ({ structure, startStudy, totalCards, reviews, onCustom }) => (
            <div className="animate-fade-in space-y-6">
                <header className="border-b border-slate-800 pb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div><h2 className="text-3xl font-bold text-white mb-2">Painel de Controle</h2><div className="flex gap-6 text-sm text-slate-400 font-mono"><span>{totalCards} Cards</span><span>{Object.keys(reviews).length} Memorizados</span></div></div>
                    <button onClick={onCustom} className="bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2"><Settings size={18} className="text-blue-400"/> Personalizar</button>
                </header>
                <Heatmap reviews={reviews} />
                <div className="grid gap-6">
                    {Object.keys(structure).length === 0 && <div className="text-center p-12 border border-dashed border-slate-800 rounded-xl text-slate-600">Sem dados.</div>}
                    {Object.keys(structure).sort().map(cat => (
                        <div key={cat} className="glass rounded-xl overflow-hidden hover:border-slate-600 transition-all group">
                            <div className="p-4 border-b border-slate-700/50 flex justify-between items-center bg-slate-900/40">
                                <h3 className="font-bold text-lg text-white flex items-center gap-3"><Folder size={18} className="text-amber-500"/> {cat}</h3>
                                <button onClick={() => startStudy(cat)} className="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded-lg font-bold flex items-center gap-1.5"><PlayCircle size={14} /> Estudar Tudo</button>
                            </div>
                            <div className="p-4 bg-slate-950/20">
                                {Object.keys(structure[cat]).sort().map(less => <LessonItem key={less} lesson={less} topics={structure[cat][less]} onStart={(l, s) => startStudy(cat, l, s)} />)}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const LessonItem = ({ lesson, topics, onStart }) => {
            const [open, setOpen] = React.useState(false);
            const count = Object.values(topics).reduce((a, c) => a + c.length, 0);
            return (
                <div className="mb-2 bg-slate-900/50 border border-slate-800 rounded-lg overflow-hidden">
                    <div className="flex items-center justify-between p-3 cursor-pointer hover:bg-slate-800" onClick={() => setOpen(!open)}>
                        <div className="flex items-center gap-3"><ChevronRight size={18} className={`transition-transform ${open ? 'rotate-90 text-blue-400' : 'text-slate-500'}`} /><span className="font-semibold text-slate-200">{lesson}</span></div>
                        <div className="flex items-center gap-3"><span className="text-xs font-mono text-slate-500">{count} cards</span><button onClick={(e) => { e.stopPropagation(); onStart(lesson); }} className="px-3 py-1 text-xs bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white rounded border border-blue-600/30">Estudar</button></div>
                    </div>
                    {open && <div className="p-2 pl-4 border-t border-slate-800 bg-slate-950/30">
                        {Object.keys(topics).map(sub => (
                            <div key={sub} className="flex justify-between items-center p-2 hover:bg-slate-800/50 rounded-lg cursor-pointer ml-4 group" onClick={() => onStart(lesson, sub)}>
                                <span className="text-slate-400 group-hover:text-slate-200 text-sm flex items-center gap-2"><div className="w-1 h-1 bg-slate-600 rounded-full group-hover:bg-blue-500"></div> {sub}</span>
                                <span className="text-[10px] bg-slate-800 text-slate-500 px-2 py-0.5 rounded border border-slate-700">{topics[sub].length}</span>
                            </div>
                        ))}
                    </div>}
                </div>
            );
        };

        const StudySession = ({ queue, user, reviews, setReviews, onFinish }) => {
            const [idx, setIdx] = React.useState(0);
            const [flip, setFlip] = React.useState(false);
            const [done, setDone] = React.useState(false);
            const [start, setStart] = React.useState(Date.now());
            
            if (done || queue.length === 0) return (
                <div className="flex flex-col items-center justify-center h-[60vh] text-center animate-fade-in">
                    <div className="w-24 h-24 bg-emerald-500/10 rounded-full flex items-center justify-center text-emerald-500 mb-6 border border-emerald-500/20"><Check size={48} /></div>
                    <h2 className="text-3xl font-bold text-white mb-2">Buffer Limpo</h2>
                    <button onClick={onFinish} className="bg-slate-800 hover:bg-slate-700 text-white px-8 py-3 rounded-xl font-bold mt-8 border border-slate-700">Voltar</button>
                </div>
            );

            const card = queue[idx];
            const curr = reviews[card.id] || { interval: 0, ease: 2.5, state: 'learning' };
            const opts = [1,2,3,4].map(r => calculateNextReview(r, curr));

            const rate = async (r) => {
                if (user) {
                    const res = calculateNextReview(r, curr);
                    const upd = { ...reviews, [card.id]: { ...res, dueDate: { toDate: () => res.dueDate }, lastReviewed: { toDate: () => new Date() } } };
                    setReviews(upd);
                    setStart(Date.now());
                    await setDoc(doc(db, `users/${user.uid}/reviews/${card.id}`), { ...res, lastReviewed: serverTimestamp() });
                    const total = Object.keys(upd).length;
                    const grad = Object.values(upd).filter(x => x.state === 'graduated').length;
                    await setDoc(doc(db, 'leaderboard', user.uid), { email: user.email, total, retention: total ? (grad/total)*100 : 0, timeStudied: increment(Date.now() - start), lastActive: serverTimestamp() }, { merge: true });
                }
                setFlip(false);
                if (idx < queue.length - 1) setIdx(idx + 1); else setDone(true);
            };

            return (
                <div className="max-w-3xl mx-auto mt-4 h-[80vh] flex flex-col perspective-1000">
                    <div className="w-full h-1 bg-slate-800 rounded-full mb-4"><div className="h-full bg-blue-500 transition-all" style={{ width: `${((idx)/queue.length)*100}%` }}></div></div>
                    <div className="flex justify-between items-center text-xs text-slate-500 uppercase mb-4 px-2">
                        <div className="flex items-center gap-2"><span className="bg-slate-900 px-2 py-1 rounded text-blue-400 border border-slate-800">{card.category}</span><span className="text-slate-600">/</span><span className="text-slate-300">{card.lesson}</span></div>
                        <span>{idx + 1} / {queue.length}</span>
                    </div>
                    <div className="relative flex-1 group">
                        <div className={`w-full h-full duration-500 transform-style-3d transition-transform relative ${flip ? 'rotate-y-180' : ''}`}>
                            <div className="absolute inset-0 backface-hidden glass border border-slate-700 rounded-3xl p-8 flex flex-col items-center text-center shadow-2xl bg-slate-900/90">
                                <div className="absolute top-4 right-4 text-slate-600 hover:text-blue-400 cursor-pointer" onClick={(e) => { e.stopPropagation(); speakText(card.front); }}><Volume2 size={24} /></div>
                                <div className="flex-1 w-full flex items-center justify-center overflow-auto"><div className="prose prose-invert prose-lg text-white" dangerouslySetInnerHTML={{__html: card.front}}></div></div>
                                <button onClick={() => setFlip(true)} className="mt-6 bg-slate-800 hover:bg-slate-700 text-blue-400 px-8 py-3 rounded-full font-bold border border-slate-700">Revelar</button>
                            </div>
                            <div className="absolute inset-0 backface-hidden rotate-y-180 glass border-2 border-blue-500/30 rounded-3xl p-8 flex flex-col items-center shadow-2xl bg-slate-900/95">
                                <div className="flex-1 w-full overflow-auto"><div className="prose prose-invert prose-lg text-slate-200 text-center" dangerouslySetInnerHTML={{__html: card.back}}></div></div>
                            </div>
                        </div>
                    </div>
                    <div className={`grid grid-cols-4 gap-4 mt-6 transition-all ${flip ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                        {['Errei','Difícil','Bom','Fácil'].map((l, i) => (
                            <button key={i} onClick={() => rate(i+1)} className={`p-4 rounded-2xl bg-slate-900 border border-slate-700 flex flex-col items-center hover:scale-105 active:scale-95 transition-all ${i===0?'hover:text-red-400':i===1?'hover:text-slate-200':i===2?'hover:text-blue-400':'hover:text-emerald-400'}`}>
                                <span className="font-bold text-sm mb-1">{l}</span><span className="text-[10px] opacity-60 font-mono">{formatTimeLabel(opts[i].interval)}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const LeaderboardView = () => {
            const [list, setList] = React.useState([]);
            React.useEffect(() => { getDocs(query(collection(db, 'leaderboard'), orderBy('retention', 'desc'), limit(50))).then(s => setList(s.docs.map(d => d.data()))); }, []);
            return (
                <div className="max-w-4xl mx-auto animate-fade-in">
                    <div className="flex items-center gap-4 mb-8 p-4 glass rounded-xl"><Trophy className="text-yellow-500" size={24}/><h2 className="text-2xl font-bold text-white">Ranking Global</h2></div>
                    <div className="glass rounded-xl overflow-hidden shadow-xl overflow-x-auto">
                        <table className="w-full text-left border-collapse min-w-[600px]">
                            <thead className="bg-slate-900/80 text-slate-400 uppercase text-xs font-bold"><tr><th className="p-5">#</th><th className="p-5">Estudante</th><th className="p-5 text-center">XP</th><th className="p-5 text-center">Tempo</th><th className="p-5 text-center">Retenção</th></tr></thead>
                            <tbody className="divide-y divide-slate-800">{list.map((l, i) => (
                                <tr key={i} className="hover:bg-slate-800/30"><td className="p-5 font-mono text-slate-500">#{i+1}</td><td className="p-5 text-white">{l.email?.split('@')[0]}</td><td className="p-5 text-center text-blue-400 font-mono">{l.total}</td><td className="p-5 text-center text-slate-300 font-mono text-sm">{formatDuration(l.timeStudied)}</td><td className="p-5 text-center"><span className={`px-2 py-1 rounded text-xs border ${l.retention > 80 ? 'border-emerald-500/30 text-emerald-400' : 'border-yellow-500/30 text-yellow-400'}`}>{l.retention?.toFixed(1)}%</span></td></tr>
                            ))}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ cards, setCards, onExit }) => {
            const [form, setForm] = React.useState({ front: '', back: '', category: 'Geral', lesson: 'Conteúdo Geral', subcategory: '' });
            const [editId, setEditId] = React.useState(null);
            const [filters, setFilters] = React.useState({ cat: 'Todos', less: 'Todos', sub: 'Todos', search: '' });

            // CORREÇÃO CRÍTICA: Normalização dos dados existentes para evitar duplicatas nos filtros
            const unique = (key) => [...new Set(cards.map(c => normalize(c[key])))].filter(Boolean).sort();
            const cats = unique('category');
            const less = unique('lesson');
            const subs = unique('subcategory');

            // CORREÇÃO CRÍTICA: Lógica de filtragem com normalização
            const filtered = cards.filter(c => {
                const matchCat = filters.cat === 'Todos' || normalize(c.category) === filters.cat;
                const matchLess = filters.less === 'Todos' || normalize(c.lesson) === filters.less;
                const matchSub = filters.sub === 'Todos' || normalize(c.subcategory) === filters.sub;
                const matchSearch = !filters.search || (c.front||'').toLowerCase().includes(filters.search.toLowerCase());
                return matchCat && matchLess && matchSub && matchSearch;
            });

            const save = async (e) => {
                e.preventDefault();
                if(!form.front || !form.back) return;
                // CORREÇÃO CRÍTICA: Sanitização antes de salvar
                const data = { 
                    front: form.front, 
                    back: form.back, 
                    category: normalize(form.category || 'Geral'), 
                    lesson: normalize(form.lesson || 'Conteúdo Geral'), 
                    subcategory: normalize(form.subcategory || 'Geral') 
                };
                try {
                    if (editId) {
                        await updateDoc(doc(db, "cards", editId), data);
                        setCards(cards.map(c => c.id === editId ? { ...c, ...data } : c));
                        setEditId(null);
                    } else {
                        const ref = await addDoc(collection(db, "cards"), { ...data, createdAt: serverTimestamp() });
                        setCards([...cards, { id: ref.id, ...data }]);
                    }
                    setForm({ ...form, front: '', back: '' }); 
                    alert("Salvo com sucesso!");
                } catch (e) { alert("Erro: " + e.message); }
            };

            const del = async (id) => { if(confirm("Deletar?")) { await deleteDoc(doc(db, "cards", id)); setCards(cards.filter(c => c.id !== id)); } };

            return (
                <div className="glass p-6 rounded-2xl border border-slate-700 min-h-screen flex flex-col shadow-2xl">
                    <div className="flex justify-between mb-4 border-b border-slate-700 pb-4"><h2 className="text-xl font-bold text-amber-500 flex items-center gap-2"><Lock size={18}/> {editId ? 'Editando' : 'Admin Console'}</h2><button onClick={onExit}><X size={20} className="text-slate-400 hover:text-white"/></button></div>
                    <div className="flex flex-col md:flex-row gap-6 flex-1 overflow-hidden">
                        <div className="w-full md:w-1/3 flex flex-col border-r border-slate-700/50 pr-4">
                            <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 mb-3 space-y-2">
                                <div className="flex items-center gap-2 mb-2"><Filter size={14}/><span className="text-xs font-bold uppercase text-slate-500">Filtros ({filtered.length})</span></div>
                                <select value={filters.cat} onChange={e => setFilters({...filters, cat: e.target.value})} className="w-full bg-slate-800 text-xs p-2 rounded border border-slate-700 text-slate-300"><option value="Todos">Todas Matérias</option>{cats.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                <select value={filters.less} onChange={e => setFilters({...filters, less: e.target.value})} className="w-full bg-slate-800 text-xs p-2 rounded border border-slate-700 text-slate-300"><option value="Todos">Todas Aulas</option>{less.map(l=><option key={l} value={l}>{l}</option>)}</select>
                                <select value={filters.sub} onChange={e => setFilters({...filters, sub: e.target.value})} className="w-full bg-slate-800 text-xs p-2 rounded border border-slate-700 text-slate-300"><option value="Todos">Todos Tópicos</option>{subs.map(s=><option key={s} value={s}>{s}</option>)}</select>
                                <input placeholder="Buscar..." value={filters.search} onChange={e => setFilters({...filters, search: e.target.value})} className="w-full bg-slate-800 text-xs p-2 rounded border border-slate-700 text-slate-300"/>
                            </div>
                            <div className="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                                {filtered.map(c => (
                                    <div key={c.id} onClick={() => { setForm({ front: c.front, back: c.back, category: normalize(c.category), lesson: normalize(c.lesson), subcategory: normalize(c.subcategory) }); setEditId(c.id); }} className={`p-3 rounded-lg text-xs border cursor-pointer ${editId === c.id ? 'bg-blue-900/20 border-blue-500/50' : 'bg-slate-900/40 border-slate-800 hover:border-slate-600'} group`}>
                                        <div className="flex justify-between items-start">
                                            <div><div className="text-blue-400 font-mono opacity-70 mb-1">{c.category}</div><div className="text-slate-300 line-clamp-2" dangerouslySetInnerHTML={{__html: c.front.replace(/<[^>]*>/g, '')}}></div></div>
                                            <button onClick={(e) => { e.stopPropagation(); del(c.id); }} className="text-red-400 hover:bg-red-900/30 p-1 rounded opacity-0 group-hover:opacity-100"><Trash2 size={12}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto pl-2 custom-scrollbar">
                            <form onSubmit={save} className="space-y-4 bg-slate-900/20 p-2 rounded-xl">
                                <div className="grid grid-cols-3 gap-2">
                                    {['category','lesson','subcategory'].map(f => (
                                        <div key={f}><label className="text-[10px] uppercase font-bold text-slate-500">{f}</label>
                                        <input list={`list-${f}`} className="w-full bg-slate-800 p-2 rounded border border-slate-700 text-xs text-white" value={form[f]} onChange={e => setForm({...form, [f]: e.target.value})} />
                                        <datalist id={`list-${f}`}>{(f==='category'?cats:f==='lesson'?less:subs).map(i=><option key={i} value={i}/>)}</datalist></div>
                                    ))}
                                </div>
                                <div><label className="text-[10px] uppercase font-bold text-slate-500">Pergunta</label><RichTextEditor value={form.front} onChange={v => setForm({...form, front: v})} /></div>
                                <div><label className="text-[10px] uppercase font-bold text-slate-500">Resposta</label><RichTextEditor value={form.back} onChange={v => setForm({...form, back: v})} /></div>
                                <div className="flex gap-2">
                                    {editId && <button type="button" onClick={() => { setEditId(null); setForm({...form, front:'', back:''}); }} className="bg-slate-700 text-white px-4 py-2 rounded text-sm">Cancelar</button>}
                                    <button className="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-sm">{editId ? 'Salvar Alterações' : 'Adicionar Card'}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        class ErrorBoundary extends React.Component { constructor(props) { super(props); this.state = { hasError: false }; } static getDerivedStateFromError(error) { return { hasError: true }; } render() { if (this.state.hasError) return <div className="text-center p-10 text-red-500">System Failure. Reload.</div>; return this.props.children; } }
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
